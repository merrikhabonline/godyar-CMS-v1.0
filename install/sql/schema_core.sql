SET time_zone = '+03:00'; SET FOREIGN_KEY_CHECKS=0; DROP TABLE IF EXISTS news_tags; DROP TABLE IF EXISTS role_permissions; DROP TABLE IF EXISTS user_roles; DROP TABLE IF EXISTS news; DROP TABLE IF EXISTS tags; DROP TABLE IF EXISTS pages; DROP TABLE IF EXISTS settings; DROP TABLE IF EXISTS categories; DROP TABLE IF EXISTS permissions; DROP TABLE IF EXISTS roles; DROP TABLE IF EXISTS users; SET FOREIGN_KEY_CHECKS=1; CREATE TABLE users ( id SERIAL PRIMARY KEY, name VARCHAR(190) NULL, username VARCHAR(60) NOT NULL, email VARCHAR(190) NOT NULL, password_hash VARCHAR(255) NOT NULL, /* Legacy compatibility: some parts still reference password */ password VARCHAR(255) NULL, role VARCHAR(100) NOT NULL DEFAULT 'user', is_admin BOOLEAN NOT NULL DEFAULT false, status VARCHAR(20) NOT NULL DEFAULT 'active', avatar VARCHAR(255) NULL, last_login_at DATETIME NULL, created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP, updated_at DATETIME NULL DEFAULT NULL ON UPDATE CURRENT_TIMESTAMP, UNIQUE KEY uniq_users_email (email), UNIQUE KEY uniq_users_username (username), KEY idx_users_role (role), KEY idx_users_status (status), KEY idx_users_is_admin (is_admin) ); CREATE TABLE roles ( id SERIAL PRIMARY KEY, name VARCHAR(60) NOT NULL, label VARCHAR(120) NOT NULL, description TEXT NULL, is_system BOOLEAN NOT NULL DEFAULT true, created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP, updated_at DATETIME NULL DEFAULT NULL ON UPDATE CURRENT_TIMESTAMP, UNIQUE KEY uniq_roles_name (name) ); CREATE TABLE permissions ( id SERIAL PRIMARY KEY, code VARCHAR(120) NOT NULL, label VARCHAR(190) NOT NULL, description TEXT NULL, created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP, UNIQUE KEY uniq_permissions_code (code) ); CREATE TABLE role_permissions ( role_id INT NOT NULL, permission_id INT NOT NULL, PRIMARY KEY (role_id, permission_id) ); CREATE TABLE user_roles ( user_id INT NOT NULL, role_id INT NOT NULL, PRIMARY KEY (user_id, role_id) ); INSERT INTO roles (name,label,description,is_system) SELECT 'admin','مدير النظام','صلاحيات كاملة',1 WHERE NOT EXISTS (SELECT 1 FROM roles WHERE name='admin'); INSERT INTO roles (name,label,description,is_system) SELECT 'writer','كاتب','كتابة وتعديل أخبار',1 WHERE NOT EXISTS (SELECT 1 FROM roles WHERE name='writer'); INSERT INTO roles (name,label,description,is_system) SELECT 'user','مستخدم','حساب مستخدم عادي',1 WHERE NOT EXISTS (SELECT 1 FROM roles WHERE name='user'); INSERT INTO permissions (code,label,description) SELECT '*','صلاحيات كاملة','جميع الصلاحيات' WHERE NOT EXISTS (SELECT 1 FROM permissions WHERE code='*'); INSERT INTO permissions (code,label,description) SELECT 'manage_users','إدارة المستخدمين',NULL WHERE NOT EXISTS (SELECT 1 FROM permissions WHERE code='manage_users'); INSERT INTO permissions (code,label,description) SELECT 'manage_roles','إدارة الأدوار والصلاحيات',NULL WHERE NOT EXISTS (SELECT 1 FROM permissions WHERE code='manage_roles'); INSERT INTO permissions (code,label,description) SELECT 'manage_security','إعدادات الأمان',NULL WHERE NOT EXISTS (SELECT 1 FROM permissions WHERE code='manage_security'); INSERT INTO permissions (code,label,description) SELECT 'manage_plugins','إدارة الإضافات',NULL WHERE NOT EXISTS (SELECT 1 FROM permissions WHERE code='manage_plugins'); INSERT INTO permissions (code,label,description) SELECT 'posts.*','إدارة الأخبار',NULL WHERE NOT EXISTS (SELECT 1 FROM permissions WHERE code='posts.*'); INSERT INTO role_permissions (role_id, permission_id) SELECT r.id, p.id FROM roles r, permissions p WHERE r.name='admin' AND p.code='*' AND NOT EXISTS ( SELECT 1 FROM role_permissions rp WHERE rp.role_id=r.id AND rp.permission_id=p.id ); CREATE TABLE categories ( id SERIAL PRIMARY KEY, name VARCHAR(190) NOT NULL, slug VARCHAR(190) NOT NULL, parent_id INT NULL, sort_order INT NOT NULL DEFAULT 0, is_active BOOLEAN NOT NULL DEFAULT true, created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP, updated_at DATETIME NULL DEFAULT NULL ON UPDATE CURRENT_TIMESTAMP, UNIQUE KEY uniq_categories_slug (slug), KEY idx_categories_parent (parent_id) ); CREATE TABLE news ( id SERIAL PRIMARY KEY, category_id INT NULL, opinion_author_id INT NULL, title VARCHAR(255) NOT NULL, slug VARCHAR(255) NOT NULL, excerpt TEXT NULL, content LONGTEXT NULL, status VARCHAR(30) NOT NULL DEFAULT 'published', featured_image VARCHAR(255) NULL, image_path VARCHAR(255) NULL, image VARCHAR(255) NULL, is_breaking BOOLEAN NOT NULL DEFAULT false, view_count INT NOT NULL DEFAULT 0, published_at DATETIME NULL, created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP, updated_at DATETIME NULL DEFAULT NULL ON UPDATE CURRENT_TIMESTAMP, deleted_at DATETIME NULL, UNIQUE KEY uniq_news_slug (slug), KEY idx_news_category (category_id), KEY idx_news_opinion_author (opinion_author_id), KEY idx_news_status (status), KEY idx_news_published (published_at) ); CREATE TABLE tags ( id SERIAL PRIMARY KEY, name VARCHAR(120) NOT NULL, slug VARCHAR(190) NOT NULL, is_active BOOLEAN NOT NULL DEFAULT true, created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP, UNIQUE KEY uniq_tags_slug (slug) ); CREATE TABLE news_tags ( news_id INT NOT NULL, tag_id INT NOT NULL, PRIMARY KEY (news_id, tag_id) ); CREATE TABLE comments ( id INT UNSIGNED NOT NULL AUTO_INCREMENT, news_id INT NOT NULL, user_id INT NULL, guest_name VARCHAR(190) NULL, guest_email VARCHAR(190) NULL, body TEXT NOT NULL, status VARCHAR(30) NOT NULL DEFAULT 'pending', parent_id INT NULL, ip VARCHAR(64) NULL, user_agent VARCHAR(255) NULL, created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP, updated_at DATETIME NULL DEFAULT NULL ON UPDATE CURRENT_TIMESTAMP, PRIMARY KEY (id), KEY idx_comments_news (news_id), KEY idx_comments_status (status), KEY idx_comments_parent (parent_id) ); CREATE TABLE pages ( id SERIAL PRIMARY KEY, title VARCHAR(255) NOT NULL, slug VARCHAR(190) NOT NULL, content LONGTEXT NULL, status VARCHAR(30) NOT NULL DEFAULT 'published', created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP, updated_at DATETIME NULL DEFAULT NULL ON UPDATE CURRENT_TIMESTAMP, UNIQUE KEY uniq_pages_slug (slug) ); CREATE TABLE settings ( setting_key VARCHAR(120) NOT NULL PRIMARY KEY, value LONGTEXT NULL, updated_at DATETIME NULL DEFAULT NULL ON UPDATE CURRENT_TIMESTAMP ); UPDATE settings SET value='Godyar', updated_at=CURRENT_TIMESTAMP WHERE setting_key='site_name'; INSERT INTO settings(setting_key,value,updated_at) SELECT 'site_name','Godyar',CURRENT_TIMESTAMP WHERE NOT EXISTS (SELECT 1 FROM settings WHERE setting_key='site_name'); UPDATE settings SET value='ar', updated_at=CURRENT_TIMESTAMP WHERE setting_key='site_lang'; INSERT INTO settings(setting_key,value,updated_at) SELECT 'site_lang','ar',CURRENT_TIMESTAMP WHERE NOT EXISTS (SELECT 1 FROM settings WHERE setting_key='site_lang'); UPDATE settings SET value='rtl', updated_at=CURRENT_TIMESTAMP WHERE setting_key='site_dir'; INSERT INTO settings(setting_key,value,updated_at) SELECT 'site_dir','rtl',CURRENT_TIMESTAMP WHERE NOT EXISTS (SELECT 1 FROM settings WHERE setting_key='site_dir'); CREATE TABLE news_translations ( id INT UNSIGNED NOT NULL AUTO_INCREMENT, news_id INT NOT NULL, lang VARCHAR(12) NOT NULL, title VARCHAR(255) NULL, content LONGTEXT NULL, created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP, updated_at DATETIME NULL DEFAULT NULL ON UPDATE CURRENT_TIMESTAMP, PRIMARY KEY (id), UNIQUE KEY uniq_news_lang (news_id, lang), KEY idx_lang (lang), KEY idx_news (news_id) ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci; CREATE TABLE featured_videos ( id INT UNSIGNED NOT NULL AUTO_INCREMENT, title VARCHAR(255) NOT NULL, url VARCHAR(500) NOT NULL, thumbnail VARCHAR(500) NULL, sort_order INT UNSIGNED NOT NULL DEFAULT 0, is_active TINYINT(1) NOT NULL DEFAULT 1, created_by INT NULL, created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP, updated_at DATETIME NULL DEFAULT NULL ON UPDATE CURRENT_TIMESTAMP, PRIMARY KEY (id), KEY idx_active (is_active), KEY idx_sort (sort_order) ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci; CREATE TABLE opinion_authors ( id INT UNSIGNED NOT NULL AUTO_INCREMENT, name VARCHAR(190) NOT NULL, slug VARCHAR(190) NOT NULL, bio TEXT NULL, avatar VARCHAR(255) NULL, is_active BOOLEAN NOT NULL DEFAULT true, display_order INT NOT NULL DEFAULT 0, articles_count INT NOT NULL DEFAULT 0, created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP, updated_at DATETIME NULL DEFAULT NULL ON UPDATE CURRENT_TIMESTAMP, PRIMARY KEY (id), UNIQUE KEY uniq_opinion_authors_slug (slug), KEY idx_opinion_authors_active (is_active), KEY idx_opinion_authors_order (display_order) );
