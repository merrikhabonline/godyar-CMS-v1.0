<?php
// /frontend/views/partials/header.php

if (!function_exists('h')) {
    function h($v): string {
        return htmlspecialchars((string)$v, ENT_QUOTES, 'UTF-8');
    }
}

/**
 * قراءة حالة العضو من الجلسة
 */
if (session_status() !== PHP_SESSION_ACTIVE) {
    @session_start();
}

$currentUser = $_SESSION['user'] ?? null;

if (!isset($isLoggedIn)) {
    $isLoggedIn = is_array($currentUser) && !empty($currentUser['id']);
}

if (!isset($isAdmin)) {
    $role    = $currentUser['role'] ?? '';
    $isAdmin = $isLoggedIn && in_array($role, ['admin','superadmin','manager'], true);
}

/**
 * جلب إعدادات الموقع من HomeController (جدول settings)
 */
$siteSettings = [];
if (class_exists('HomeController')) {
    try {
        $siteSettings = HomeController::getSiteSettings();
        if (!is_array($siteSettings)) {
            $siteSettings = [];
        }
    } catch (Throwable $e) {
        $siteSettings = [];
    }
}

// المتغيرات الأساسية مع أولوية لما يمرره السكربت ثم الإعدادات ثم الافتراضي
$siteName    = $siteName    ?? ($siteSettings['site_name']    ?? 'Godyar News');
$siteTagline = $siteTagline ?? ($siteSettings['site_tagline'] ?? 'منصة إخبارية متكاملة');
$siteLogo    = $siteLogo    ?? ($siteSettings['site_logo']    ?? '');

$primaryColor = $primaryColor ?? ($siteSettings['theme_primary'] ?? '#0ea5e9');
$primaryDark  = $primaryDark  ?? '#0369a1';

$themeClass   = $themeClass   ?? 'theme-default';

$searchPlaceholder = $searchPlaceholder ?? 'ابحث عن خبر أو موضوع...';
$headerCategories  = $headerCategories  ?? [];
$isLoggedIn        = $isLoggedIn        ?? false;
$isAdmin           = $isAdmin           ?? false;

// ضبط baseUrl
if (isset($baseUrl) && $baseUrl !== '') {
    $baseUrl = rtrim($baseUrl, '/');
} elseif (function_exists('base_url')) {
    $baseUrl = rtrim(base_url(), '/');
} else {
    $baseUrl = '';
}
$baseUrl = preg_replace('#/frontend/controllers$#', '', $baseUrl);

/**
 * تحميل التصنيفات للهيدر
 */
if (empty($headerCategories)) {
    try {
        $pdo = gdy_pdo_safe();

        if ($pdo instanceof \PDO) {
            $catNameColumn = 'name';
            $columns = [];

            try {
                $colStmt = gdy_db_stmt_columns($pdo, 'categories');
                $columns = $colStmt->fetchAll(\PDO::FETCH_COLUMN, 0);
            } catch (\Throwable $e) {
                // تجاهل
            }

            if (!in_array('name', $columns, true)) {
                if (in_array('category_name', $columns, true)) {
                    $catNameColumn = 'category_name';
                } elseif (in_array('cat_name', $columns, true)) {
                    $catNameColumn = 'cat_name';
                } elseif (in_array('title', $columns, true)) {
                    $catNameColumn = 'title';
                } else {
                    $catNameColumn = null;
                }
            }

            $hasParentColumn = in_array('parent_id', $columns, true);

            if ($catNameColumn !== null) {
                if ($hasParentColumn) {
                    $sql = "SELECT id, {$catNameColumn} AS name, slug, parent_id FROM categories ORDER BY parent_id IS NULL DESC, parent_id ASC, id ASC";
                } else {
                    $sql = "SELECT id, {$catNameColumn} AS name, slug FROM categories ORDER BY id ASC";
                }
            } else {
                if ($hasParentColumn) {
                    $sql = "SELECT id, slug, parent_id FROM categories ORDER BY parent_id IS NULL DESC, parent_id ASC, id ASC";
                } else {
                    $sql = "SELECT id, slug FROM categories ORDER BY id ASC";
                }
            }

            $stmt = $pdo->query($sql);
            $rows = $stmt->fetchAll(\PDO::FETCH_ASSOC);

            if (is_array($rows) && !empty($rows)) {
                $headerCategories = $rows;
            }
        }
    } catch (\Throwable $e) {
        $headerCategories = $headerCategories ?? [];
    }
}
?>
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <title><?= h($siteName) ?> - <?= h($siteTagline) ?></title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="description" content="<?= h($siteTagline) ?>">

  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
        crossorigin="anonymous" referrerpolicy="no-referrer" />

  <?php if (!empty($siteSettings['extra_head_code'])): ?>
    <?= $siteSettings['extra_head_code'] . "\n" ?>
  <?php endif; ?>

  <style>
    :root {
      --primary: <?= h($primaryColor) ?>;
      --primary-light: <?= h($primaryColor) ?>22;
      --primary-dark: <?= h($primaryDark) ?>;

      --bg-page: #f1fbff;      /* الخلفية العامة الفاتحة للمحتوى */
      --bg-header: #020617;    /* خلفية داكنة ثابتة للهيدر */
      --bg-footer: #020617;

      --card-gradient: linear-gradient(
        135deg,
        #fdfaf4 0%,
        #fbe8cf 30%,
        #e4fbff 100%
      );
      --card-border: #d5e3f0;

      --text-main: #0f172a;
      --text-muted: #64748b;
      --radius-lg: 18px;
      --shadow-soft: 0 16px 30px rgba(15,23,42,0.12);
      --shadow-hover: 0 20px 40px rgba(15,23,42,0.18);

      /* ✅ يُضبط تلقائياً عبر JS لمنع دخول المحتوى تحت الهيدر */
      --header-h: 0px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    html { scroll-behavior: smooth; scroll-padding-top: calc(var(--header-h) + 12px); }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", "Tajawal", sans-serif;
      background: var(--bg-page);
      color: var(--text-main);
      line-height: 1.6;
      overflow-x: hidden;
    }

    a { color: inherit; text-decoration: none; transition: all 0.3s ease; }
    a:hover { text-decoration: none; }

    .container {
      width: 100%;
      max-width: 1180px;
      margin: 0 auto;
      padding: 0 16px;
    }

    /* ===== الهيدر الداكن (مع وضوح عالي للكتابة) ===== */
    .site-header {
      position: sticky;
      top: 0;
      z-index: 1000;

      /* ✅ لازم شفافية عشان backdrop-filter يشتغل */
      background: rgba(2, 6, 23, 0.92);
      color: #f9fafb;

      border-bottom: 1px solid rgba(2, 6, 23, 0.9);
      box-shadow: 0 18px 40px rgba(15,23,42,0.9);

      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);

      /* تحسين الأداء */
      will-change: transform;
    }

    /* ✅ بديل للمتصفحات التي لا تدعم blur */
    @supports not ((backdrop-filter: blur(1px)) or (-webkit-backdrop-filter: blur(1px))) {
      .site-header { background: var(--bg-header); }
    }

    .header-inner {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      padding: 14px 0;
    }

    .brand-block {
      display: flex;
      align-items: center;
      gap: 10px;
      transition: transform 0.3s ease;
    }
    .brand-block:hover { transform: translateY(-2px); }

    .brand-logo {
      width: 44px;
      height: 44px;
      border-radius: 16px;
      background: radial-gradient(circle at top, var(--primary), #020617);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #0b1120;
      font-size: 1.3rem;
      box-shadow: 0 0 18px rgba(56,189,248,.6);
      overflow: hidden;
      flex-shrink: 0;
      transition: all 0.3s ease;
      position: relative;
    }
    .brand-logo img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .brand-logo::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(45deg, transparent, rgba(255,255,255,0.3), transparent);
      transform: translateX(-100%);
    }
    .brand-logo:hover::before {
      transform: translateX(100%);
      transition: transform 0.6s ease;
    }
    .brand-logo:hover {
      transform: rotate(5deg) scale(1.05);
      box-shadow: 0 0 25px rgba(56,189,248,.85);
    }

    .brand-text { text-align: right; }
    .brand-title {
      font-size: 1rem;
      font-weight: 700;
      color: #ffffff;
    }
    .brand-subtitle {
      font-size: .78rem;
      color: #e5e7eb;
    }

    .top-nav-wrapper {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 4px;
      flex: 1;
    }

    .top-nav {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      font-size: .8rem;
      justify-content: flex-end;
      align-items: center;
    }
    .top-nav a {
      padding: 6px 11px;
      border-radius: 999px;
      background: #020617;
      border: 1px solid rgba(148,163,184,0.6);
      color: #f9fafb;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    .top-nav a::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
      transform: translateX(-100%);
    }
    .top-nav a:hover::before {
      transform: translateX(100%);
      transition: transform 0.6s ease;
    }
    .top-nav a:hover {
      border-color: var(--primary);
      background: #020617;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(14,165,233,0.4);
    }

    .auth-links {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      font-size: .75rem;
      justify-content: flex-end;
    }
    .auth-links a {
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.7);
      background: #020617;
      color: #f9fafb;
      transition: all 0.3s ease;
    }
    .auth-links a.primary-auth {
      border-color: var(--primary);
      background: var(--primary);
      color: #0b1120;
      font-weight: 600;
    }
    .auth-links a:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 10px rgba(15,23,42,0.7);
    }

    /* شريط التصنيفات + البحث */
    .header-secondary {
      border-top: 1px solid #0b1120;
      padding-bottom: 8px;
      background: #020617;
    }
    .header-secondary-inner {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 12px;
      padding-top: 8px;
      padding-bottom: 8px;
    }
    .cats-nav {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      font-size: .78rem;
    }
    .cats-nav a {
      padding: 4px 10px;
      border-radius: 999px;
      background: #020617;
      border: 1px solid rgba(75,85,99,0.95);
      color: #f9fafb;
      transition: all 0.3s ease;
    }
    .cats-nav a:hover {
      border-color: var(--primary);
      background: #020617;
      transform: translateY(-2px);
    }

    .header-search {
      margin-inline-start: auto;
      position: relative;
      min-width: 220px;
      max-width: 280px;
      flex: 1;
    }
    .header-search input {
      width: 100%;
      padding: 6px 30px 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.8);
      background: #020617;
      color: #f9fafb;
      font-size: .78rem;
      transition: all 0.3s ease;
    }
    .header-search input::placeholder {
      color: #9ca3af;
    }
    .header-search input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(14,165,233,0.25);
    }
    .header-search-icon {
      position: absolute;
      right: 9px;
      top: 50%;
      transform: translateY(-50%);
      font-size: .78rem;
      color: #9ca3af;
      transition: color 0.3s ease;
    }
    .header-search:focus-within .header-search-icon {
      color: var(--primary);
    }

    main {
      background: transparent;
      min-height: calc(100vh - 140px);
    }
    .page-shell { padding: 24px 0 28px; }

    @media (max-width: 992px) {
      .header-inner {
        flex-direction: column;
        align-items: flex-start;
      }
      .header-secondary-inner {
        flex-direction: column;
        align-items: flex-start;
      }
      .header-search {
        width: 100%;
        max-width: none;
        margin-inline-start: 0;
      }
      .top-nav-wrapper { align-items: flex-start; }
    }

    /* ===== زر الانتخابات المتوهج (مصغّر) ===== */
    .top-nav-elections {
      position: relative;
      display: inline-flex;
      align-items: center;
    }

    .elections-cta {
      position: relative;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 3px 10px 3px 8px;
      border-radius: 999px;
      background: rgba(15,23,42,0.98);
      border: 1px solid rgba(239,68,68,0.7);
      color: #fee2e2;
      font-size: .75rem;
      font-weight: 600;
      box-shadow:
        0 0 0 1px rgba(127,29,29,0.3),
        0 0 14px rgba(248,113,113,0.9),
        0 0 28px rgba(248,113,113,0.7);
      overflow: visible;
      cursor: pointer;
      isolation: isolate;
    }

    .elections-cta:hover {
      transform: translateY(-1px) scale(1.01);
      box-shadow:
        0 0 0 1px rgba(127,29,29,0.5),
        0 0 18px rgba(248,113,113,1),
        0 0 34px rgba(248,113,113,0.85);
      background: rgba(15,23,42,1);
    }

    .elections-cta-core {
      position: relative;
      width: 30px;
      height: 30px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 0, #fecaca, #b91c1c);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow:
        0 0 0 2px rgba(248,250,252,0.06),
        0 0 16px rgba(248,113,113,1);
      z-index: 2;
    }

    .elections-cta-core i {
      font-size: .9rem;
      text-shadow: 0 0 6px rgba(255,255,255,0.6);
    }

    .elections-cta-orbits {
      position: absolute;
      inset: 50% auto auto 50%;
      transform: translate(-50%, -50%);
      width: 42px;
      height: 42px;
      pointer-events: none;
      z-index: 1;
    }

    .elections-cta-orbit {
      position: absolute;
      inset: 0;
      border-radius: 999px;
      border: 1px solid rgba(248,113,113,0.6);
      box-shadow:
        0 0 10px rgba(248,113,113,0.85),
        0 0 22px rgba(127,29,29,0.7);
      mix-blend-mode: screen;
    }

    .elections-cta-orbit.orbit-1 { animation: elections-orbit-1 2.6s ease-in-out infinite; }
    .elections-cta-orbit.orbit-2 { animation: elections-orbit-2 3.2s ease-in-out infinite; }

    .elections-cta-text {
      position: relative;
      z-index: 2;
      white-space: nowrap;
      letter-spacing: .02em;
    }

    .elections-cta-close {
      position: absolute;
      top: -6px;
      left: -6px;
      width: 18px;
      height: 18px;
      border-radius: 999px;
      border: none;
      background: rgba(15,23,42,0.9);
      color: #fecaca;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: .65rem;
      cursor: pointer;
      padding: 0;
      box-shadow: 0 0 6px rgba(0,0,0,0.7);
      z-index: 3;
    }
    .elections-cta-close:hover {
      background: #7f1d1d;
      color: #fee2e2;
    }

    .elections-cta-show {
      font-size: .7rem;
    }
    .elections-cta-show button {
      padding: 4px 9px;
      border-radius: 999px;
      border: 1px dashed rgba(148,163,184,0.7);
      background: #020617;
      color: #e5e7eb;
      cursor: pointer;
      font-size: .7rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      transition: all 0.3s ease;
    }
    .elections-cta-show button:hover {
      border-style: solid;
      border-color: rgba(248,113,113,0.8);
      color: #fecaca;
    }
    .elections-cta-show button i {
      font-size: .8rem;
    }

    @keyframes elections-orbit-1 {
      0%   { transform: scale(0.9); opacity: .8; }
      50%  { transform: scale(1.08); opacity: 1; }
      100% { transform: scale(0.9); opacity: .8; }
    }
    @keyframes elections-orbit-2 {
      0%   { transform: scale(1.15) rotate(0deg); opacity: .7; }
      50%  { transform: scale(1.32) rotate(8deg); opacity: 1; }
      100% { transform: scale(1.15) rotate(0deg); opacity: .7; }
    }

    @media (max-width: 992px) {
      .elections-cta { width: 100%; justify-content: center; }
      .elections-cta-show { width: 100%; }
      .elections-cta-show button { width: 100%; text-align: center; }
    }
  </style>
</head>
<body class="<?= h($themeClass) ?>">

<header class="site-header">
  <div class="container">
    <div class="header-inner">
      <a href="<?= h($baseUrl) ?>" class="brand-block">
        <div class="brand-logo">
          <?php if ($siteLogo): ?>
            <img src="<?= h($siteLogo) ?>" alt="<?= h($siteName) ?>">
          <?php else: ?>
            <i class="fa-solid fa-newspaper"></i>
          <?php endif; ?>
        </div>
        <div class="brand-text">
          <div class="brand-title"><?= h($siteName) ?></div>
          <div class="brand-subtitle"><?= h($siteTagline) ?></div>
        </div>
      </a>

      <div class="top-nav-wrapper">
        <nav class="top-nav" aria-label="روابط سريعة">
          <a href="<?= h($baseUrl) ?>/trending">
            <i class="fa-solid fa-fire"></i>
            <span>الأكثر تداولاً</span>
          </a>

          <!-- زر الانتخابات المتوهج -->
          <span class="top-nav-elections" id="elections-cta-wrapper">
            <a href="<?= h($baseUrl) ?>/elections.php" class="elections-cta" id="elections-cta">
              <span class="elections-cta-orbits">
                <span class="elections-cta-orbit orbit-1"></span>
                <span class="elections-cta-orbit orbit-2"></span>
              </span>
              <span class="elections-cta-core">
                <i class="fa-solid fa-square-poll-vertical"></i>
              </span>
              <span class="elections-cta-text">الانتخابات</span>
              <button type="button"
                      class="elections-cta-close"
                      id="elections-cta-close"
                      title="إخفاء رابط الانتخابات">
                <i class="fa-solid fa-xmark"></i>
              </button>
            </a>
          </span>

          <!-- زر إظهار رابط الانتخابات (نص مخفي، أيقونة فقط) -->
          <span class="elections-cta-show d-none" id="elections-cta-show">
            <button type="button" title="إظهار رابط الانتخابات">
              <i class="fa-regular fa-circle-dot"></i>
            </button>
          </span>
        </nav>

        <div class="auth-links">
          <?php if (!$isLoggedIn): ?>
            <a href="<?= h($baseUrl) ?>/login" class="primary-auth">
              <i class="fa-solid fa-right-to-bracket"></i>
              <span>تسجيل الدخول</span>
            </a>
            <a href="<?= h($baseUrl) ?>/register">
              <i class="fa-regular fa-user"></i>
              <span>إنشاء حساب</span>
            </a>
          <?php else: ?>
            <?php if ($isAdmin): ?>
              <a href="<?= h($baseUrl) ?>/admin/">
                <i class="fa-solid fa-gauge-high"></i>
                <span>لوحة التحكم</span>
              </a>
            <?php endif; ?>
            <a href="<?= h($baseUrl) ?>/logout.php">
              <i class="fa-solid fa-right-from-bracket"></i>
              <span>تسجيل الخروج</span>
            </a>
          <?php endif; ?>
        </div>
      </div>
    </div>

    <div class="header-secondary">
      <div class="container">
        <div class="header-secondary-inner">
          <nav class="cats-nav" aria-label="أقسام الموقع">
          <a href="<?= h($baseUrl) ?>" class="cats-link cats-link--home">
            <i class="fa-solid fa-house"></i>
            <span>الرئيسية</span>
          </a>

          <?php if (!empty($headerCategories)): ?>
            <?php
              // بناء شجرة للتصنيفات (رئيسية + فرعية)
              $headerCategoriesTree = $headerCategoriesTree ?? null;

              if ($headerCategoriesTree === null) {
                  $byId = [];
                  foreach ($headerCategories as $row) {
                      $id = (int)($row['id'] ?? 0);
                      if ($id <= 0) { continue; }
                      $row['children'] = [];
                      $byId[$id] = $row;
                  }

                  foreach ($byId as $id => &$row) {
                      $pid = isset($row['parent_id']) ? (int)$row['parent_id'] : 0;
                      if ($pid > 0 && isset($byId[$pid])) {
                          $byId[$pid]['children'][] =& $row;
                      }
                  }
                  unset($row);

                  $headerCategoriesTree = [];
                  foreach ($byId as $id => $row) {
                      $pid = isset($row['parent_id']) ? (int)$row['parent_id'] : 0;
                      if ($pid === 0) {
                          $headerCategoriesTree[] = $row;
                      }
                  }
              }

              // كلاسات مميزة لكل قسم حسب slug
              $specialCatStyles = [
                  'opinion'         => 'cats-link--opinion',
                  'opinion-writers' => 'cats-link--opinion',
                  'book-opinion'    => 'cats-link--opinion',
                  'videos'          => 'cats-link--videos',
                  'video'           => 'cats-link--videos',
                  'video-news'      => 'cats-link--videos',
                  'sports'          => 'cats-link--sports',
                  'sport'           => 'cats-link--sports',
                  'football'        => 'cats-link--sports',
                  'business'        => 'cats-link--business',
                  'economy'         => 'cats-link--business',
                  'tech'            => 'cats-link--tech',
                  'technology'      => 'cats-link--tech',
                  'culture'         => 'cats-link--culture',
              ];

              $renderHeaderCat = function (array $cat) use (&$renderHeaderCat, $baseUrl, $specialCatStyles) {
                  $catSlug = trim((string)($cat['slug'] ?? ''));
                  if ($catSlug === '') {
                      $catSlug = (string)($cat['id'] ?? '');
                  }
                  $catName = $cat['name'] ?? 'قسم';
                  $hasChildren = !empty($cat['children']);

                  $cls  = 'cats-link';
                  $icon = 'fa-regular fa-newspaper';

                  // تحديد ما إذا كان هذا رابط "الرأي / كتّاب الرأي"
                  $isOpinionLink = in_array($catSlug, ['opinion', 'opinion-writers', 'book-opinion'], true);

                  foreach ($specialCatStyles as $slugKey => $className) {
                      if ($catSlug === $slugKey) {
                          $cls .= ' ' . $className;
                          if (strpos($className, 'opinion') !== false) {
                              $icon = 'fa-solid fa-feather';
                          } elseif (strpos($className, 'videos') !== false) {
                              $icon = 'fa-solid fa-video';
                          } elseif (strpos($className, 'sports') !== false) {
                              $icon = 'fa-solid fa-futbol';
                          } elseif (strpos($className, 'business') !== false) {
                              $icon = 'fa-solid fa-coins';
                          } elseif (strpos($className, 'tech') !== false) {
                              $icon = 'fa-solid fa-microchip';
                          } elseif (strpos($className, 'culture') !== false) {
                              $icon = 'fa-solid fa-masks-theater';
                          }
                      }
                  }

                  // ضبط اسم القسم لرابط "كتّاب الرأي"
                  if ($isOpinionLink) {
                      $catName = 'كتّاب الرأي';
                  }

                  // مسار الرابط: الأقسام العادية → /category/{slug}
                  // قسم "الرأي" → ينقل إلى صفحة كتّاب الرأي
                  if ($isOpinionLink) {
                      $href = rtrim($baseUrl, '/') . '/opinion_author.php';
                  } else {
                      $href = rtrim($baseUrl, '/') . '/category/' . rawurlencode($catSlug);
                  }
              ?>
                <div class="cats-item <?= $hasChildren ? 'has-children' : '' ?>">
                  <a href="<?= h($href) ?>" class="<?= h($cls) ?>">
                    <i class="<?= h($icon) ?>"></i>
                    <span><?= h($catName) ?></span>
                  </a>
                  <?php if ($hasChildren): ?>
                    <div class="cats-submenu">
                      <?php foreach ($cat['children'] as $child): ?>
                        <?php $renderHeaderCat($child); ?>
                      <?php endforeach; ?>
                    </div>
                  <?php endif; ?>
                </div>
              <?php
              };
            ?>

            <?php foreach ($headerCategoriesTree as $catRoot): ?>
              <?php $renderHeaderCat($catRoot); ?>
            <?php endforeach; ?>

          <?php else: ?>
            <a href="<?= h($baseUrl) ?>/category/general-news" class="cats-link">
              <i class="fa-regular fa-newspaper"></i>
              <span>أخبار عامة</span>
            </a>
            <a href="<?= h($baseUrl) ?>/category/politics" class="cats-link">
              <i class="fa-solid fa-landmark-flag"></i>
              <span>سياسة</span>
            </a>
            <a href="<?= h($baseUrl) ?>/category/business" class="cats-link cats-link--business">
              <i class="fa-solid fa-coins"></i>
              <span>اقتصاد</span>
            </a>
            <a href="<?= h($baseUrl) ?>/category/sports" class="cats-link cats-link--sports">
              <i class="fa-solid fa-futbol"></i>
              <span>رياضة</span>
            </a>
          <?php endif; ?>
          </nav>

          <form class="header-search" action="<?= h($baseUrl) ?>/search" method="get">
            <input type="search" placeholder="<?= h($searchPlaceholder) ?>" name="q">
            <span class="header-search-icon"><i class="fa-solid fa-search"></i></span>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script>
    // منطق إخفاء/إظهار زر الانتخابات + ضبط ارتفاع الهيدر تلقائياً
    document.addEventListener('DOMContentLoaded', function () {
      var wrapper = document.getElementById('elections-cta-wrapper');
      var closeBtn = document.getElementById('elections-cta-close');
      var showBox  = document.getElementById('elections-cta-show');
      var showBtn  = showBox ? showBox.querySelector('button') : null;

      var hidden = false;
      try {
        hidden = window.localStorage.getItem('hide_elections_cta') === '1';
      } catch (e) {}

      function updateVisibility() {
        if (!wrapper || !showBox) return;
        if (hidden) {
          wrapper.classList.add('d-none');
          showBox.classList.remove('d-none');
        } else {
          wrapper.classList.remove('d-none');
          showBox.classList.add('d-none');
        }
      }

      updateVisibility();

      if (closeBtn) {
        closeBtn.addEventListener('click', function (ev) {
          ev.preventDefault();
          ev.stopPropagation();
          hidden = true;
          updateVisibility();
          try { window.localStorage.setItem('hide_elections_cta', '1'); } catch (e) {}
        });
      }

      if (showBtn) {
        showBtn.addEventListener('click', function () {
          hidden = false;
          updateVisibility();
          try { window.localStorage.removeItem('hide_elections_cta'); } catch (e) {}
        });
      }

      // ✅ ضبط --header-h لمنع دخول المحتوى/السكرول تحت الهيدر
      function setHeaderH(){
        var header = document.querySelector('.site-header');
        if (!header) return;
        document.documentElement.style.setProperty('--header-h', header.offsetHeight + 'px');
      }
      setHeaderH();
      window.addEventListener('resize', setHeaderH);
    });
  </script>
</header>

<main>
  <div class="page-shell">
    <div class="container">
