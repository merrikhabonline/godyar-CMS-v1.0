# PostgreSQL / SQL Dialect Compatibility Notes (Godyar CMS v1.0)

This repository ships with **MySQL/MariaDB-first** SQL schema and migrations.
Some static analyzers (or CI checks configured for non-MySQL dialects) may flag
MySQL-specific syntax as "syntax errors" (e.g., `AFTER`, `UNSIGNED`, backticks, `AUTO_INCREMENT`, etc.).

## What was added in this release candidate

A **PostgreSQL-oriented** set of SQL files has been generated from the existing MySQL SQL, placed under:

- `install/sql/postgresql/`  (schema + runtime patch scripts)
- `database/migrations/postgresql/`
- `admin/db/migrations/postgresql/`
- `migrations/postgresql/`
- `database/postgresql/admin_menu.sql`

These files remove/translate common MySQL-only syntax:
- `AFTER ...` clauses in `ALTER TABLE ... ADD COLUMN ...` (PostgreSQL does not support column ordering)
- backticks (`` `name` ``) -> plain identifiers
- `AUTO_INCREMENT` -> `GENERATED BY DEFAULT AS IDENTITY`
- `UNSIGNED` -> removed (PostgreSQL does not have unsigned integer types)
- `LONGTEXT/MEDIUMTEXT` -> `TEXT`
- `DATETIME` -> `TIMESTAMP`
- `TINYINT(1)` -> `BOOLEAN`

## Important limitation (remaining work)

Adding PostgreSQL-flavored **SQL files alone is not sufficient** to run the CMS on PostgreSQL.

The PHP codebase contains multiple MySQL-specific query patterns, including (non-exhaustive):
- `NOW()` usage (should be replaced with `CURRENT_TIMESTAMP` or handled in PHP)
- `vendor-specific upsert clause` upserts (PostgreSQL uses `ON CONFLICT (...) DO UPDATE ...`)
- potential MySQL-specific functions depending on usage (e.g., `IFNULL()`, `GROUP_CONCAT()`, etc.)

### Recommended approach to complete PostgreSQL support professionally

1. **Define the target scope**
   - If you only need to satisfy a static analyzer: configure it for MySQL, or point it to the new PostgreSQL SQL folder.
   - If you want true runtime support: proceed with steps below.

2. **Add a small DB-dialect helper layer**
   - Detect driver via PDO: `$pdo->getAttribute(PDO::ATTR_DRIVER_NAME)` (`mysql`, `pgsql`, `sqlite`).
   - Provide helpers:
     - `db_now_expr()` returning `NOW()` for mysql, `CURRENT_TIMESTAMP` for pgsql.
     - `db_upsert()` helper to generate the correct UPSERT clause for the active driver.

3. **Migrate MySQL-only UPSERTs**
   - Replace `... vendor-specific upsert clause ...` with `... ON CONFLICT (unique_col) DO UPDATE SET ...`
   - You must identify the conflict target (unique index/constraint) per table.

4. **Review types & constraints**
   - Because `UNSIGNED` is removed, consider adding `CHECK (col >= 0)` where non-negative semantics matter.

5. **Run an integration test on PostgreSQL**
   - Create an empty DB, apply `install/sql/postgresql/schema_core.sql` then optional fks, then migrations.
   - Run the app with `DB_DSN=pgsql:host=...;dbname=...` and validate core flows.

## Where to start (high impact)
- Search for `vendor-specific upsert clause` and migrate those first.
- Then replace `NOW()` calls or centralize them via a helper.
- Finally, address any remaining MySQL functions.

